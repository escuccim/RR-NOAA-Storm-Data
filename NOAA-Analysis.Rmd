---
title: "Analysis of Storm Types for Economic and Health Damage"
author: "Eric Scuccimarra"
date: "28 December 2017"
output: 
    html_document:
        keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Abstract

The purpose of this analysis is to determine which types of severe weather events have the greatest impact on population health, and which have the greatest economic impact. To accomplish this we will look at storm data collected by NOAA from 1950 to 2011.

## Data Loading and Preprocessing

We start by downloading the bzipped CSV file from the course website and loading the data in.

```{r loaddata, cache=TRUE}
download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", "StormData.csv.bz2")
rawdata <- read.csv(bzfile("StormData.csv.bz2")) 
```

Next we will remove the variables which are not relevant to the analysis.

```{r preprocessdata,cache=TRUE}
data <- rawdata[, c("EVTYPE","FATALITIES","INJURIES","PROPDMG","PROPDMGEXP","CROPDMG","CROPDMGEXP")]
```

The property and crop damage values are expressed in terms of a character which indicates whether the number is in hundreds, thousands, millions, or billions. To set the damage figures to be in dollars, we will convert the data accordingly. Once this is done we can remove the unneeded columns.

```{r updatedamages, cache=TRUE}
data$PROPDMGEXP <- toupper(data$PROPDMGEXP)
data$CROPDMGEXP <- toupper(data$CROPDMGEXP)

exp_translations <- data.frame(EXP = c("H", "K","M","B"), VALUE=c(100,1000,1000000,1000000000))
data <- merge(data, exp_translations, by.x = "PROPDMGEXP", by.y="EXP")
names(data)[names(data) == "VALUE"] <- "PROPDMGMOD"
data <- merge(data, exp_translations, by.x="CROPDMGEXP", by.y="EXP")
names(data)[names(data) == "VALUE"] <- "CROPDMGMOD"

data$PROPDMG <- data$PROPDMG * data$PROPDMGMOD
data$CROPDMG <- data$CROPDMG * data$CROPDMGMOD

data <- data[,-c(1,2,8,9)]
```

Finally we can combine the Property and Crop damage into one column since we are only concerned with total damage and the breakdown is not relevant to this analysis.

```{r totaleconomicdamage}
data$ECONDMG <- data$PROPDMG + data$CROPDMG
data <- data[,-c(4,5)]
```

Many of the hurricanes and storms are referenced individually by name, so in order to gauge which types of events are most damaging I attempted to group the types into 27 groups. When in doubt, I erred on the side of making the groups overly broad rather than overly specific with the assumption that this would provide the best generalized results.

```{r relabelevents}
data$EVTYPE <- toupper(data$EVTYPE)
data$EVTYPE[grepl("FLOOD", data$EVTYPE)] <- "FLOOD"
data$EVTYPE[grepl("FLD", data$EVTYPE)] <- "FLOOD"
data$EVTYPE[grepl("HURRICANE", data$EVTYPE)] <- "HURRICANE"
data$EVTYPE[grepl("THUNDERSTORM", data$EVTYPE)] <- "THUNDERSTORM"
data$EVTYPE[grepl("STORM SURGE", data$EVTYPE)] <- "THUNDERSTORM"
data$EVTYPE[grepl("TROPICAL DEPRESSION", data$EVTYPE)] <- "TROPICAL STORM"
data$EVTYPE[grepl("TROPICAL STORM", data$EVTYPE)] <- "TROPICAL STORM"
data$EVTYPE[grepl("TORNADO", data$EVTYPE)] <- "TORNADO"
data$EVTYPE[grepl("GUSTNADO", data$EVTYPE)] <- "WIND"
data$EVTYPE[grepl("WIND", data$EVTYPE)] <- "WIND"
data$EVTYPE[grepl("SMOKE", data$EVTYPE)] <- "FIRE"
data$EVTYPE[grepl("FIRE", data$EVTYPE)] <- "FIRE"
data$EVTYPE[grepl("RIP CURRENT", data$EVTYPE)] <- "TIDE"
data$EVTYPE[grepl("ASTRONOMICAL", data$EVTYPE)] <- "TIDE"
data$EVTYPE[grepl("HEAT", data$EVTYPE)] <- "HEAT"
data$EVTYPE[grepl("ICE", data$EVTYPE)] <- "ICE"
data$EVTYPE[grepl("ICY", data$EVTYPE)] <- "ICE"
data$EVTYPE[grepl("RAIN", data$EVTYPE)] <- "RAIN"
data$EVTYPE[grepl("HAIL", data$EVTYPE)] <- "WINTER STORM"
data$EVTYPE[grepl("SNOW", data$EVTYPE)] <- "WINTER STORM"
data$EVTYPE[grepl("WINTER", data$EVTYPE)] <- "WINTER STORM"
data$EVTYPE[grepl("BLIZZARD", data$EVTYPE)] <- "WINTER STORM"
data$EVTYPE[grepl("SLEET", data$EVTYPE)] <- "WINTER STORM"
data$EVTYPE[grepl("SURF", data$EVTYPE)] <- "SURF"
data$EVTYPE[grepl("FREEZE", data$EVTYPE)] <- "EXTREME COLD"
data$EVTYPE[grepl("FOG", data$EVTYPE)] <- "FOG"
data$EVTYPE[grepl("DUST", data$EVTYPE)] <- "DUST STORM"
data$EVTYPE <- as.factor(data$EVTYPE)
```

## Analysis

### Economic Damage to Crops and Property

First we will look at economic damage by storm type, considering both the mean damage and the total damage caused by each type of event:

```{r economicdamage}
library(dplyr)
econ_dmg_total <- aggregate(ECONDMG ~ EVTYPE, data=data, sum)
econ_dmg_mean <- aggregate(ECONDMG ~ EVTYPE, data=data, mean, na.rm=TRUE)
econ_summary <- merge(econ_dmg_total, econ_dmg_mean, by="EVTYPE")
names(econ_summary) <- c("EVTYPE","TOTAL","MEAN")
```

Now we will look at the types of events by greatest mean damage and by greatest total damage. To do this I sort the economic damage summary data by both total and mean, take the top 5 events for each, and then take the subset of the data which corresponds to the set of max events for either mean or total. This leaves 8 unique events.

```{r econsummary}
es_top_total <- econ_summary[order(desc(econ_summary$TOTAL))[1:5],]$EVTYPE
es_top_mean <- econ_summary[order(desc(econ_summary$MEAN))[1:5],]$EVTYPE
top_events <- subset(econ_summary, econ_summary$EVTYPE %in% es_top_total | econ_summary$EVTYPE %in% es_top_mean)
```

Now we can plot the events with the total and mean costs:
```{r ploteconsummary}
par(mfrow=c(1,2))
barplot(top_events$TOTAL/1000000, names=top_events$EVTYPE,ylab="Total Damage (in millions)",col=top_events$EVTYPE,legend.text=top_events$EVTYPE)
barplot(top_events$MEAN/1000000, names=top_events$EVTYPE,ylab="Mean Damage (in millions)",col=top_events$EVTYPE)
```

We see that floods cause by far greater total damage, followed by hurricanes, while in terms of mean damage hurricanes are by far the most destructive, followed by tsunamis. This is attributable to the fact that there are `r sum(data$EVTYPE == "FLOOD")` flood events in the data set, while only `r sum(data$EVTYPE == "HURRICANE")` hurricane events. Although on average a hurricane causes 93.10 times more economic damage than a flood, the much higher number of floods makes them the greatest contributer to economic damage.

### Population Health Damage

Now we will investigate the effects on population health in terms of fatalities and injuries.

```{r summarizehealtheffects}
data$ECONDMG <- NULL
data$TOTALHEALTH = data$FATALITIES + data$INJURIES
health_means <- data %>% group_by(EVTYPE) %>% summarize_all(mean)
health_sums <- data %>% group_by(EVTYPE) %>% summarize_all(sum)
```

Now we can merge the data by mean and by total:
```{r mergehealthdata}
health_summary <- merge(health_means,health_sums,by="EVTYPE",suffixes=c(".MEAN",".TOTAL"))
```

As with economic damage, I will get the top five event types by mean and total injuries and fatalities and then subset the data set to only include those events:
```{r subsethealthdata}
total_fatalities <- as.character(health_summary[order(desc(health_summary$FATALITIES.TOTAL))[1:5],]$EVTYPE)
total_injuries <- as.character(health_summary[order(desc(health_summary$INJURIES.TOTAL))[1:5],]$EVTYPE)
mean_fatalities <- as.character(health_summary[order(desc(health_summary$FATALITIES.MEAN))[1:5],]$EVTYPE)
mean_injuries <- as.character(health_summary[order(desc(health_summary$INJURIES.MEAN))[1:5],]$EVTYPE)
top_events = unique(c(total_fatalities,total_injuries,mean_fatalities,mean_injuries))
top_health <- subset(health_summary, health_summary$EVTYPE %in% top_events)
top_health$EVTYPE <- as.factor(top_health$EVTYPE)
```

Finally we can plot the types of events against the numbers of injuries, fatalities or both:
```{r plothealthdata}

```

[1]: https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf "Data Description"